generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

/* =====================================================
 * Master / Actor Tables
 * ===================================================== */

/**
 * Physician (‡πÅ‡∏û‡∏ó‡∏¢‡πå)
 * - ‡πÅ‡∏û‡∏ó‡∏¢‡πå 1 ‡∏Ñ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏• / ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö exam ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
 */
model Physician {
  id        String   @id @default(uuid())
  fullName  String   @unique        // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
  createdAt DateTime @default(now())

  exams     Exam[]   @relation("PhysicianExam")
}

/**
 * Operator (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à)
 * - Operator 1 ‡∏Ñ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥ exam ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏™
 */
model Operator {
  id        String   @id @default(uuid())
  fullName  String   @unique
  createdAt DateTime @default(now())

  exams     Exam[]
}

/**
 * Department (‡πÅ‡∏ú‡∏ô‡∏Å)
 * - 1 ‡πÅ‡∏ú‡∏ô‡∏Å ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
 * - 1 ‡πÅ‡∏ú‡∏ô‡∏Å ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
 */
model Department {
  id        String   @id @default(uuid())
  name      String   @unique        // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å
  createdAt DateTime @default(now())

  devices   Device[]
  exams     Exam[]
}

/**
 * Device (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à)
 * - ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏™‡∏°‡∏≠
 * - 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏™
 * - 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏°‡∏µ maintenance ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
 */
model Device {
  id            String   @id @default(uuid())
  name          String   @unique        // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
  model         String?
  isActive      Boolean  @default(true)
  departmentId  String                  // FK ‚Üí Department
  createdAt     DateTime @default(now())

  department    Department @relation(fields: [departmentId], references: [id])
  exams         Exam[]
  maintenances  MaintenanceRecord[]
  deviceProbes  DeviceProbe[]

  @@index([departmentId])
}

/**
 * ExamType (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à)
 * ‡πÄ‡∏ä‡πà‡∏ô Abdomen, Cardiac, OB/GYN
 */
model ExamType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  exams     Exam[]
}

/* =====================================================
 * Core Transaction Table
 * ===================================================== */

/**
 * Exam (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à)
 * üëâ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
 * ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° ExamType, Device, Probe, Department, Operator, Physician
 */
model Exam {
  id            String   @id @default(uuid())

  examTypeId    String               // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
  deviceId      String               // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
  probeId       String?              // probe ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ö‡∏≤‡∏á exam ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ)
  departmentId  String               // ‡πÅ‡∏ú‡∏ô‡∏Å
  operatorId    String?              // ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
  physicianId   String?              // ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•

  startedAt     DateTime             // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à
  finishedAt    DateTime?            // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
  status        ExamStatus @default(COMPLETED)
  createdAt     DateTime @default(now())

  // relations
  examType      ExamType    @relation(fields: [examTypeId], references: [id])
  device        Device      @relation(fields: [deviceId], references: [id])
  probe         Probe?      @relation(fields: [probeId], references: [id])
  department    Department @relation(fields: [departmentId], references: [id])
  operator      Operator?  @relation(fields: [operatorId], references: [id])
  physician     Physician? @relation("PhysicianExam", fields: [physicianId], references: [id])

  // indexes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö analytics / dashboard
  @@index([deviceId, startedAt], map: "exam_device_startedat_idx")
  @@index([probeId, startedAt], map: "exam_probe_startedat_idx")
  @@index([departmentId, startedAt], map: "exam_department_startedat_idx")
  @@index([examTypeId, startedAt], map: "exam_examtype_startedat_idx")
  @@index([operatorId, startedAt], map: "exam_operator_startedat_idx")
  @@index([physicianId, startedAt], map: "exam_physician_startedat_idx")
  @@index([startedAt], map: "exam_startedat_idx")
}

/* =====================================================
 * Maintenance
 * ===================================================== */

/**
 * MaintenanceRecord
 * - ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
 */
model MaintenanceRecord {
  id          String   @id @default(uuid())
  deviceId    String
  title       String
  details     String?
  type        MaintenanceType   // PREVENTIVE / CORRECTIVE
  status      MaintenanceStatus // SCHEDULED / COMPLETED
  startedAt   DateTime?
  finishedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  device      Device @relation(fields: [deviceId], references: [id])

  @@index([deviceId])
  @@index([type])
  @@index([status])
}

/* =====================================================
 * Probe & Device Mapping
 * ===================================================== */

/**
 * Probe (‡∏´‡∏±‡∏ß‡∏ï‡∏£‡∏ß‡∏à)
 * - probe 1 ‡∏≠‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ exam
 * - probe 1 ‡∏≠‡∏±‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ
 */
model Probe {
  id        String   @id @default(uuid())
  name      String
  type      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  deviceProbes DeviceProbe[]
  exams        Exam[]
}

/**
 * DeviceProbe (Join Table)
 * - many-to-many ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Device ‚Üî Probe
 */
model DeviceProbe {
  deviceId String
  probeId  String

  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  device Device @relation(fields: [deviceId], references: [id])
  probe  Probe  @relation(fields: [probeId], references: [id])

  @@id([deviceId, probeId])
  @@index([deviceId])
  @@index([probeId])
}

/* =====================================================
 * Summary / Cache Tables (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard)
 * ===================================================== */

/**
 * ExamDailySummary
 * - ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô exam ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
 * - optional group by examType / department
 */
model ExamDailySummary {
  id            String   @id @default(uuid())
  date          DateTime @db.Date
  examTypeId    String?
  departmentId  String?
  total         Int

  @@unique([date, examTypeId, departmentId])
}

/**
 * ExamMonthlySummary
 * - ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
 */
model ExamMonthlySummary {
  id            String   @id @default(uuid())
  year          Int
  month         Int
  examTypeId    String?
  departmentId  String?
  total         Int

  @@unique([year, month, examTypeId, departmentId])
}

/**
 * ProbeDailySummary
 * - ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏î probe utilization
 */
model ProbeDailySummary {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  probeId   String
  examCount Int

  @@unique([date, probeId])
}

/**
 * DepartmentDailySummary
 * - cache dashboard ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å
 */
model DepartmentDailySummary {
  date          DateTime @db.Date
  departmentId  String
  examCount     Int

  @@unique([date, departmentId])
}

/**
 * ExamTypeDailySummary
 */
model ExamTypeDailySummary {
  date        DateTime @db.Date
  examTypeId  String
  examCount   Int

  @@unique([date, examTypeId])
}

/**
 * OperatorDailySummary
 */
model OperatorDailySummary {
  date        DateTime @db.Date
  operatorId  String
  examCount   Int

  @@unique([date, operatorId])
}

/**
 * PhysicianDailySummary
 */
model PhysicianDailySummary {
  date          DateTime @db.Date
  physicianId   String
  examCount     Int

  @@unique([date, physicianId])
}

/**
 * DeviceDailyUtilization
 * - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OEE / utilization
 */
model DeviceDailyUtilization {
  date               DateTime @db.Date
  deviceId           String
  usedMinutes        Int
  availableMinutes   Int
  utilizationRate    Float

  @@unique([date, deviceId])
}

/**
 * DeviceMonthlySummary
 */
model DeviceMonthlySummary {
  year              Int
  month             Int
  deviceId          String
  examCount         Int
  operatingMinutes  Int

  @@unique([year, month, deviceId])
}

/* =====================================================
 * Enums
 * ===================================================== */

enum MaintenanceType {
  PREVENTIVE     // ‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô
  CORRECTIVE     // ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢
  CALIBRATION    // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
  INSPECTION     // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
