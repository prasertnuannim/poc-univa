generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

model Physician {
  id        String   @id @default(uuid())  @db.Uuid
  fullName  String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())

  exams Exam[] @relation("PhysicianExam") //หมอ 1 คน → อ่านผล / รับผิดชอบ exam ได้หลายรายการ
}

model Operator {
  id        String   @id @default(uuid()) @db.Uuid
  fullName  String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())

  exams Exam[] //Operator 1 คน → ทำ exam ได้หลายเคส
}

model Department {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())

  devices Device[] // 1 แผนก : หลายเครื่อง
  exams   Exam[] // 1 แผนก : หลายการตรวจ
}

model Device {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique @db.VarChar(255)
  model        String? @db.VarChar(255)
  isActive     Boolean  @default(true)
  departmentId String @db.Uuid // บังคับให้ เครื่องต้องอยู่ในแผนกเสมอ
  createdAt    DateTime @default(now())

  department   Department          @relation(fields: [departmentId], references: [id]) // many Devices → one Department
  exams        Exam[] //1 เครื่อง → ตรวจได้หลายเคส
  maintenances MaintenanceRecord[] // 1 Device มี MaintenanceRecord ได้หลายรายการ
  deviceProbes DeviceProbe[]

  @@index([departmentId])
}

model ExamType {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())

  exams Exam[] // 1 ExamType : หลาย Exam
}

// เป็นศูนย์กลางที่เชื่อม
model Exam {
  id String @id @default(uuid()) @db.Uuid

  examTypeId   String @db.Uuid
  deviceId     String @db.Uuid
  probeId      String? @db.Uuid
  departmentId String @db.Uuid
  operatorId   String? @db.Uuid
  physicianId  String? @db.Uuid
  startedAt    DateTime
  finishedAt   DateTime?
  status       ExamStatus @default(COMPLETED)
  createdAt    DateTime   @default(now())

  // relations
  examType   ExamType   @relation(fields: [examTypeId], references: [id])
  device     Device     @relation(fields: [deviceId], references: [id])
  probe      Probe?     @relation(fields: [probeId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  operator   Operator?  @relation(fields: [operatorId], references: [id])
  physician  Physician? @relation("PhysicianExam", fields: [physicianId], references: [id])

  // composite indexes index ที่มี มากกว่า 1 คอลัมน์ใช้query กรองหลายเงื่อนไขพร้อมกัน
  @@index([deviceId, startedAt], map: "exam_device_startedat_idx")
  @@index([probeId, startedAt], map: "exam_probe_startedat_idx")
  @@index([departmentId, startedAt], map: "exam_department_startedat_idx")
  @@index([examTypeId, startedAt], map: "exam_examtype_startedat_idx")
  @@index([operatorId, startedAt], map: "exam_operator_startedat_idx")
  @@index([physicianId, startedAt], map: "exam_physician_startedat_idx")
  @@index([startedAt], map: "exam_startedat_idx")
}

model MaintenanceRecord {
  id         String @id @default(uuid()) @db.Uuid
  deviceId   String @db.Uuid
  title      String @db.VarChar(255)
  details    String? @db.VarChar(255)
  type       MaintenanceType   @default(PREVENTIVE)
  status     MaintenanceStatus @default(COMPLETED)
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  device Device @relation(fields: [deviceId], references: [id]) //1 MaintenanceRecord ผูกกับ Device ได้แค่ 1 เครื่อง

  @@index([deviceId])
  @@index([type])
  @@index([status])
}

model Probe {
  id        String   @id @default(uuid()) @db.Uuid
  name      String @db.VarChar(255)
  type      String? @db.VarChar(255)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  deviceProbes DeviceProbe[] // many-to-many
  exams        Exam[] // probe 1 อันถูกใช้ในหลาย exam
}

// Join Table
// 1 เครื่องมีหลาย probe
// probe 1 อันย้ายไปใช้หลายเครื่องได้

model DeviceProbe {
  deviceId String @db.Uuid
  probeId  String @db.Uuid

  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  device Device @relation(fields: [deviceId], references: [id])
  probe  Probe  @relation(fields: [probeId], references: [id])

  @@id([deviceId, probeId])
  @@index([deviceId])
  @@index([probeId])
}

model ExamDailySummary {
  id           String   @id @default(uuid()) @db.Uuid
  date         DateTime @db.Date
  examTypeId   String? @db.Uuid
  departmentId String? @db.Uuid
  total        Int

  @@unique([date, examTypeId, departmentId])
}

model ExamMonthlySummary {
  id           String  @id @default(uuid()) @db.Uuid
  year         Int
  month        Int
  examTypeId   String? @db.Uuid
  departmentId String? @db.Uuid
  total        Int

  @@unique([year, month, examTypeId, departmentId])
}

model ProbeDailySummary {
  id        String   @id @default(uuid()) @db.Uuid
  date      DateTime @db.Date
  probeId   String @db.VarChar(255)
  examCount Int

  @@unique([date, probeId])
}

// caching table
model DepartmentDailySummary {
  date         DateTime @db.Date
  departmentId String @db.Uuid
  examCount    Int

  @@unique([date, departmentId])
}

model ExamTypeDailySummary {
  date       DateTime @db.Date
  examTypeId String @db.Uuid
  examCount  Int

  @@unique([date, examTypeId])
}

model OperatorDailySummary {
  date       DateTime @db.Date
  operatorId String @db.Uuid
  examCount  Int

  @@unique([date, operatorId])
}

model PhysicianDailySummary {
  date        DateTime @db.Date
  physicianId String @db.Uuid
  examCount   Int

  @@unique([date, physicianId])
}

model DeviceDailyUtilization {
  date             DateTime @db.Date
  deviceId         String @db.Uuid
  usedMinutes      Int
  availableMinutes Int
  utilizationRate  Float

  @@unique([date, deviceId])
}

model DeviceMonthlySummary {
  year             Int
  month            Int
  deviceId         String @db.Uuid
  examCount        Int
  operatingMinutes Int

  @@unique([year, month, deviceId])
}

//-----------------------------------

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  CALIBRATION
  INSPECTION
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
